#
# Copyright 2022 DXOS.org
#

#
# Party Genesis: Creating a new Party.
#

feed:
  key: Alice/Device-1/Feed-1
  messages:
    - id: 1
      data:
        # Self-signed Credential by the Party.
        @type halo.party.PartyGenesis
        partyKey: Alice-Halo # ISSUE: Different from IdentityKey?
        identityKey: Alice
    - id: 2
      data:
        # Authorizes device to sign on behalf of Identity
        # NOTE: This Credential SHOULD be Presented on joining a Party.
        @type halo.credential.Credential
        issuer: Alice # Self-signed.
        subject:
          id: Alice/Device-1
          assertion:
            @type halo.credentials.AuthorizedDevice
            identityKey: Alice
    - id: 3
      data:
        # Admits the feed to the feed graph.
        @type halo.credential.Credential
        issuer: Alice/Device-1
        subject:
          id: Alice/Device-1/Feed-1
          assertion:
            @type halo.credentials.AdmittedFeed
            partyKey: Alice-Halo
            deviceKey: Alice/Device-1

#
# Device Admission: Adding a new Device to a HALO.
# NOTE: This is the same as the initial Device Admission above, but with a different Issuer.
#

feed:
  key: Alice/Device-1/Feed-1
  messages:
    - id: 100
      data:
        @type halo.credential.Credential
        issuer: Alice/Device-1
        subject:
          id: Alice/Device-2
          assertion:
            @type halo.credentials.AuthorizedDevice
            identityKey: Alice
    - id: 101
      data:
        # NOTE: This MUST have been Presented from an authorized Device.
        @type halo.credential.Credential
        issuer: Alice/Device-2
        subject:
          id: Alice/Device-2/Feed-2 # New Feed.
          assertion:
            @type halo.credentials.AdmittedFeed
            partyKey: Alice-Halo
            deviceKey: Alice/Device-2

#
# ECHO Genesis: Creating a new Space.
#

feed:
  key: Alice/Device-1/Feed-3
  messages:
    - id: 1
      data:
        # Self-signed Credential by the Party.
        @type halo.party.Genesis # NOTE: Same as HALO.
        partyKey: Party-1
        identityKey: Alice
    - id: 2
      data:
        # Authorizes Agent.
        @type halo.credential.Credential
        issuer: Alice # Self-signed.
        subject:
          id: Alice
          assertion:
            @type halo.credentials.PartyMember
            partyKey: Party-1
            role: ADMIN

#
# Feed Admission: Device admits a new feed.
# NOTE: This happens as part of Genesis, but is exactly the same mechanism as any
#   Authorized Agent presenting a nested Feed Admission Credential.
# Any authorized Peer can Verify a Feed Admin Presentation.
#   ISSUE: How to detect and avoid multiple Peers from doing this concurrently? (e.g., Direct P2P Requests?)
#

feed:
  key: Alice/Device-1/Feed-3
    - id: 3
      data:
        # Admits Feed.
        # Credential Presented by Alice/Device-1
        # Records chain-of-trust from Alice's Halo: Alice => Alice/Device-1 => Alice/Device-1/Feed-3
        @type halo.credential.Presentation
        credentials:
          - issuer: Alice
            subject:
              id: Alice/Device-1
              assertion:
                @type halo.credentials.AuthorizedDevice
                identityKey: Alice
            proof:
              # Proof generated by Alice
              - value: eyJhbGci...yHUdBBPM
          - issuer: Alice/Device-1
            subject:
              id: Alice/Device-1/Feed-3 # NOTE: This Feed.
              assertion:
                @type halo.credentials.AdmittedFeed
                identityKey: Alice
                partyKey: Party-1
                deviceKey: Alice/Device-1
            proof:
              # Proof generated by Alice/Device-1
              - value: eyJhbGci...yHUdBBPM
        proofs:
          # Proof generated by Alice/Device-1
          - value: eyJhbGci...yHUdBBPM

#
# Member Admission: Adding a new Member to a Space.
# The joining Agent will Present a Credential representing a Feed Admission.
#

feed:
  key: Alice/Device-1/Feed-3
  messages:
    - id: 100
      data:
        @type halo.credential.Credential
        issuer: Alice/Device-1
        subject:
          id: Bob
          assertion:
            @type halo.credentials.PartyMember
            partyKey: Party-1
            role: WRITER

