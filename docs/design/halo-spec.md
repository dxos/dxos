# HALO Spec

## 1. Introduction

Users maintain a HALO, which encompasses their identity and access control rights to digital assets withint the DXOS ecosystem.
These rights are expressed cryptographically secure, privacy respecting, and machine-verifiable credentials.


## 2. Terminology

***Agent*** -
Participant (i.e., bot or user) in the peer-to-peer network.

***Credential*** - 
Signed Claim issued by an Authority to a Subject. Services require credentials to allow specific capabilities.

***Device key*** - 
Public/private key pair of particular a node belonging to an agent.
Each device contains a keyring and a replica of the HALO party.

***ECHO Party*** - 

***Feed*** - 
Hash-linked append-only signed log of immutable messages.

***Feed DAG*** - 
Graph formed by feeds admitting other feeds via FeedAdmit messages.

***HALO Party*** - 
Set of credentials, and data (e.g., preferences) for a given agent (i.e., identity). 
Replicated between all devices of the identity.

***Identity key*** - 
Public/private key pair for agents.

***Invitation*** - 
The process (sometimes interactive) of admitting a new member to a party (ECHO or HALO).

***Keychain*** - 
Set of credential messages establishing a linear chain of trust between credentials.
TOOD: Example.

***Keyring*** - 
Storage for keys (on disk or in-memory).

***Party*** -


***Profile*** -

> device => Identity {HALO, keyring = {identity pk, device sk, feeds sk }}


## 3. Basic Concepts

### Credential message
 
> See packages/common/protocols/src/proto/dxos/halo/signed.proto

A Credential message consists of:
- Signed part:
  - Timestamp of credential creation.
  - Nonce as a randomly generated by string. [Allow different signatures to have different nonces, allowing for more efficient presentation]
  - Dynamically typed payload encoded via `google.protobuf.Any`.
- List of signatures, each having:
  - The signing public key.
  - The signature itself.
  - Optional KeyChain.

ED25519 curve is used for signatures via [hypercore-crypto](https://www.npmjs.com/package/hypercore-crypto) package.

### Key chain

> See packages/common/protocols/src/proto/dxos/halo/keys.proto

A set of credential messages that establishes a chain of trust between the signing key and the trusted keys.
Allows for delegation of authority.

KeyChain is stored in a tree-like data structure.
Each entry consists of:
- Public key being described.
- A signed credential message where the public key is the subject of the credential.
- Zero or more parent KeyChains establishing the trust of the keys that signed the credential.

Example:

Parties admit identity keys as members. When a device signs a credential, it produces a signature using it's own device key and attaches a KeyChain containing a KeyAdmit message, admitting the device key to the HALO.

> Q: What's the difference between including KeyChain as a parent of a different KeyChain vs having the credential message of that KeyChain entry be signed with the first KeyChain.

> TODO: It seems only the signatures of credential messages are verified and the claims are ignored.

### Credential message types

#### Envelope 

> See packages/common/protocols/src/proto/dxos/halo/party.proto

Wraps another credential message specifying the party key and allowing to add more signatures.

#### PartyGenesis

> See packages/common/protocols/src/proto/dxos/halo/party.proto

The start-of-authority record for the Party.
Contains:
- Party key.
- Key of the initial feed to be admitted.
- Key of the initial member to be admitted.

Signed by the party key itself, as well as the subject keys.

#### KeyAdmit

> See packages/common/protocols/src/proto/dxos/halo/party.proto

Admits a new member key (identity or device key) to the party.

Must be signed by previously admitted member.

#### FeedAdmit

> See packages/common/protocols/src/proto/dxos/halo/party.proto

Admit a single feed to the Party.
This message must be signed by the feed key to be admitted, also by some other key which has already been admitted (usually by a device pseudonym key).

FeedAdmit messages are used to incrementally build the Feed DAG.

#### FeedGenesis

> See packages/common/protocols/src/proto/dxos/halo/party.proto

The start-of-authority record for the Feed.
Contains information about the owner of the feed.
The owner must be a key previously admitted to the Party

> NOTE: Currently unused.

#### IdentityInfo

> See packages/common/protocols/src/proto/dxos/halo/identity.proto

Additional, descriptive information about an Identity. Must be signed by the Identity's key.

#### DeviceInfo

> See packages/common/protocols/src/proto/dxos/halo/identity.proto

Additional, descriptive information about a Device. Must be signed by the Device's key.

#### Invitations

> TODO: describe credentials used in invitations

Ephemeral credential message that is sent during handshake for replication authentication.

Contains:
 - Party key.
 - Device key.
 - Identity key.
 - Feed key.
 - Optional FeedAdmit credential to be notarized by the authenticator so that new peers can get their feeds included in the Feed DAG.

## Processes

### HALO creation

1. Generate identity key-pair.
1. Generate device key-pair.
1. Generate feed key-pair.
1. Write HALO PartyGenesis credential:
    - Establishes the genesis of the HALO party.
    - Admits the device key.
    - Admits the feed.
    - Identity key is used as the HALO party key so it is automatically admitted. [use hash of identity key as party key?, key rotation?]
    - Signed by: identity key, device key, feed key. [why?]
1. Write IdentityGenesis (KeyAdmit) message.
    - Admits identity key.
    - Signed by: identity key.
1. Write IdentityInfo message
    - Contains the identity display name string.
    - Skipped if there's no display name for this identity.
    - Signed by: identity key. [sign by device key instead?]
1. Write DeviceInfo message
    - Contains the device display name string.
    - Skipped if there's no display name for this device.
    - Signed by: device key.
1. Create initial set of metadata items in HALO party database.
1. Destroy the secret key of identity key.

> TODO: Device key chain is formed after the HALO is created. Explain the process.

> Genesis feed

### ECHO party creation

1. Generate party key-pair.
1. Generate feed key-pair.
1. Write PartyGenesis credential message
    - Admits the feed key.
    - Admits the party key.
    - Signed by: party key, feed key.
    - [With genesis feed party-key=feed-key so we wouldn't have to admit them]
1. Wrap and write the IdentityGenesis message.
    - Copied from HALO party.
    - Additionally signed by the party key.
    - [is the original service (i.e., HALO party) of the IdentityGenesis message important?]
1. Write FeedAdmit message
    - Admits the feed key.
    - Signed by the device key-chain.
1. Copy the IdentityInfo message from the HALO party.
    - May be skipped if doesn't exist.
    - Additionally signed by device key-chain.
1. Create party metadata item in the database.
1. Destroy the secret key for the party key.

> TODO: Difference between KeyAdmit and FeedAdmit messages.
> TODO: Separate feed keys into their own domain, disallow feed keys to sign credentials.

## Credentials state machine

> TODO
> - Initial state
> - Sets of keys tracked
> - Trusted keys
> - Invitations
> - Info messages
> - Admitted by
> - Use by message selector (i.e. message orderer).

## Authenticator

> TODO

## Proposal: Genesis feed.

Special feed that is identified and signed by the party key.

Contains credential messages that establish the party genesis, admit the first member and the first member's feed.

Genesis feed is the root of the feed DAG.
Genesis feed is the definitive starting point for the party state machine.
Only the party public key, which is also the genesis feed key, is required to discover nodes on the network, authenticate with them, start replicating, and processing the party credentials in the party state machine.


## Notes

- Credential: issuer (authority); subject; claim.

- User's private key is not used for signing (just recovery of HALO).
- Device is a signing authority for a user (e.g., to create membership credenitals).
- Device presents HALO credentials to ECHO parties to join. (HALO DAG joined with ECHO DAG)
- Device graph as part of HALO. Revocation. 
  - Optionally: Blockchain registration to resolve forks. 
  - Optionally: Publish Github credential (claim) to chain/HALO in order to recover.
- Credentials should generally have narrow claims (separation of concerns).
- Devices joining an ECHO party are like offline invitations (i.e., the joiner presents a credential).


## References

1. [W3C Verifiable Credentials Data Model](https://www.w3.org/TR/vc-data-model/)










## Spec

- Identity Keys
  - Create identity
  - Support multiple identites (on all platforms: e.g., CLI, PWA)
  - Recover identity
  - External identifier (Peer DID)
  - Profile metadata (IFPS document?)
- Encrypted local storage (secured by password)
- Decentralized Credentials
  - ECHO Party replication
  - Extensible credentials (e.g., party membership, external tokens (e.g., Github), KUBE access, etc.)
  - Credential presentation
- Device management
  - Admit device
  - Revoke device
- Preferences
- Circle Contacts
  - Represent contacts as DID documents? (e.g., keys + metadata?)

### Design

- NOTE: Spaces are the new name for Parties.

- Each Agent (User or Bot) has:
  - An Identity public key.
  - A public Profile document (e.g., IPFS file discovered by a Peer DID?)
    - Peer DID resolve to DID Document via a Naming Service.
    - ISSUE: Cannot use IPNS due to single private key limitation.
    - ISSUE: KUBEs implement a federated DXNS and DID resolver.
      - DXNS is hybrid KUBE p2p/blockchain.
      - DXNS maintains a map of name (DXN) => Document (typed record) with a set of Credentials (that contains a set of public keys that have authority over the document).
  - A Set of devices that manage secure private keys and credentials.
  - A private decentralized HALO that contains:
    - A set of Credentials that represent various decentralized claims (e.g., Blockchain accounts, KUBE access, external Web2 tokens).
    - A set of Device public keys (and metadata).
    - A Circle that contains a set of Agent public keys (DIDs?) and profiles (e.g., cached DID Profile documents)

- A Credential contain a Subject and a Claim signed by an Authority.
- Spaces maintain a DAG of credentials.
- The space itself is the root authority that signs a set of Genesis messages using a temporary Private key.
- The genesis messages contain the root credentials that anchor the "chain of trust".

- Agents are identified by their Identity public key.
- The Identity key may be used to look-up the agent's profile.
  - TODO: How to lookup profile (e.g., DID document).

- Credentials may represent (multiple) roles for Agents (e.g., Admin, Writer, Reader).
- Credential may represent:
  1. Agent admission (ECHO Party only): `{ subject: Agent; claim: Role; authority: Genesis|Device }` (applies to all Agent's devices).
  2. Device admission: `{ subject: Device: claim: Agent Proxy; authority: Genesis|Device }`: Gives the Device transitive rights to act on behalf of an Agent.
  3. Feed admission: `{ subject: Device; claim: Valid; authority: Device }`
  - When an Agent's Device attempts to join the Space, it presents a credential signed by an existing admitted Device.
  - Alternatively: The new Device may present a chain of credentials that are anchored by the Agent (e.g., Agent => Device 1 => Device 2) generated from the Agent's HALO.
    - ISSUE: How to deal with device revocation (e.g., Device 1 is now invalid)

- Each Agent has Public key.
- Agent's have multiple devices, each of which have a Public/Private key.
- Each Agent maintins a public Profile document (e.g., DID document stored as IPFS file).
- The Profile document may be resolved by the network using Peer DID resolution.

### Issues

- What mechanism does Peer DID resolution? Needs Naming Service?
- TODO(pierre): Privacy review (for Spaces and Peer signaling).
  - ISSUE: A time-salted hash of the associated Public key may be used to discover the Space (i.e., MESH discovery key).
  - This hash may be transmitted publicly (e.g., as a discovery key for signaling) and provides one degree of privacy.
- TODO: Credential expiration/revocation and finality (e.g., by epoch).

### Trust and Threats

#### Aspects of Trust

- Availability: Can I find it from any node in the network.
- Correctness: Is the value verifiable? Can I invalidate fakes?
- Consensus and Finality: Can I determine that all nodes agree?
- Censorship Resistance: Am I seeing all results?

> - TODO: Convert to table.

- KUBE/MESH network for availability and correctness.
  - ISSUE: Cannot prevent censorship.
  - ISSUE: Implement peer verification using unique discovery keys?
- IPFS for availability (can validate document by hash)
- DXNS:
  - By trusted subnets.
  - By global blockchain.
- ECHO Spaces by chain-of-trust of Credentials (within scope of ECHO).
- HALO

> - TODO: DNS
> - TODO: Incentives
