# Credentials Design Doc

## Glossary

**Agent** - p2p participant (i.e., bot or user).

**Keyring** - Storage for keys (on disk or in-memory).

**KeyChain** - Set of credential messages establishing a chain of trust between keys.

**Invitation** - Process (sometimes interactive) of admitting a new member to a party (data party or HALO party).

**Credential** - Signed Claim issued by an Authority to a Subject. Services require credentials to allow specific capabilities.

**ECHO Party** - 

**HALO Party** - Set of credentials, and data (e.g., preferences) for a given agent (i.e., identity). Replicated between all devices of the identity.

**Identity key** - Public/private key pair for agents.

**Device key** - Public/private key pair of particular a node belonging to an agent.
Each device contains a keyring and a replica of the HALO party.

**Feed** - Hash-linked append-only signed log of immutable messages.

**Feed DAG** - Graph formed by feeds admitting other feeds via FeedAdmit messages.

**Profile** -

> device => Identity {HALO, keyring = {identity pk, device sk, feeds sk }}


## Credential message
 
> See packages/common/protocols/src/proto/dxos/halo/signed.proto

Credential messages consist of:
- Signed part:
  - Timestamp of credential creation.
  - Nonce as a randomly generated by string. [Allow different signatures to have different nonces, allowing for more efficient presentation]
  - Dynamically typed payload encoded via `google.protobuf.Any`.
- List of signatures, each having:
  - The signing public key.
  - The signature itself.
  - Optional KeyChain.

ED25519 curve is used for signatures via [hypercore-crypto](https://www.npmjs.com/package/hypercore-crypto) package.

### Key chain

> See packages/common/protocols/src/proto/dxos/halo/keys.proto

A set of credential messages that establishes a chain of trust between the signing key and the trusted keys.
Allows for delegation of authority.

KeyChain is stored in a tree-like data structure.
Each entry consists of:
- Public key being described.
- A signed credential message where the public key is the subject of the credential.
- Zero or more parent KeyChains establishing the trust of the keys that signed the credential.

Example:

Parties admit identity keys as members. When a device signs a credential, it produces a signature using it's own device key and attaches a KeyChain containing a KeyAdmit message, admitting the device key to the HALO.

> Q: What's the difference between including KeyChain as a parent of a different KeyChain vs having the credential message of that KeyChain entry be signed with the first KeyChain.

> TODO: It seems only the signatures of credential messages are verified and the claims are ignored.

### Credential message types

#### Envelope 

> See packages/common/protocols/src/proto/dxos/halo/party.proto

Wraps another credential message specifying the party key and allowing to add more signatures.

#### PartyGenesis

> See packages/common/protocols/src/proto/dxos/halo/party.proto

The start-of-authority record for the Party.
Contains:
- Party key.
- Key of the initial feed to be admitted.
- Key of the initial member to be admitted.

Signed by the party key itself, as well as the subject keys.

#### KeyAdmit

> See packages/common/protocols/src/proto/dxos/halo/party.proto

Admits a new member key (identity or device key) to the party.

Must be signed by previously admitted member.

#### FeedAdmit

> See packages/common/protocols/src/proto/dxos/halo/party.proto

Admit a single feed to the Party.
This message must be signed by the feed key to be admitted, also by some other key which has already been admitted (usually by a device pseudonym key).

FeedAdmit messages are used to incrementally build the Feed DAG.

#### FeedGenesis

> See packages/common/protocols/src/proto/dxos/halo/party.proto

The start-of-authority record for the Feed.
Contains information about the owner of the feed.
The owner must be a key previously admitted to the Party

> NOTE: Currently unused.

#### IdentityInfo

> See packages/common/protocols/src/proto/dxos/halo/identity.proto

Additional, descriptive information about an Identity. Must be signed by the Identity's key.

#### DeviceInfo

> See packages/common/protocols/src/proto/dxos/halo/identity.proto

Additional, descriptive information about a Device. Must be signed by the Device's key.

#### Invitations

> TODO: describe credentials used in invitations

Offline invitations are written as credential to the party control feed.

#### Auth

Ephemeral credential message that is sent during handshake for replication authentication.

Contains:
 - Party key.
 - Device key.
 - Identity key.
 - Feed key.
 - Optional FeedAdmit credential to be notarized by the authenticator so that new peers can get their feeds included in the Feed DAG.

## Processes

### HALO creation

1. Generate identity key-pair.
1. Generate device key-pair.
1. Generate feed key-pair.
1. Write HALO PartyGenesis credential:
    - Establishes the genesis of the HALO party.
    - Admits the device key.
    - Admits the feed.
    - Identity key is used as the HALO party key so it is automatically admitted. [use hash of identity key as party key?, key rotation?]
    - Signed by: identity key, device key, feed key. [why?]
1. Write IdentityGenesis (KeyAdmit) message.
    - Admits identity key.
    - Signed by: identity key.
1. Write IdentityInfo message
    - Contains the identity display name string.
    - Skipped if there's no display name for this identity.
    - Signed by: identity key. [sign by device key instead?]
1. Write DeviceInfo message
    - Contains the device display name string.
    - Skipped if there's no display name for this device.
    - Signed by: device key.
1. Create initial set of metadata items in HALO party database.
1. Destroy the secret key of identity key.

> TODO: Device key chain is formed after the HALO is created. Explain the process.

> Genesis feed

### Data party creation

1. Generate party key-pair.
1. Generate feed key-pair.
1. Write PartyGenesis credential message
    - Admits the feed key.
    - Admits the party key.
    - Signed by: party key, feed key.
    - [With genesis feed party-key=feed-key so we wouldn't have to admit them]
1. Wrap and write the IdentityGenesis message.
    - Copied from HALO party.
    - Additionally signed by the party key.
    - [is the original service (i.e., HALO party) of the IdentityGenesis message important?]
1. Write FeedAdmit message
    - Admits the feed key.
    - Signed by the device key-chain.
1. Copy the IdentityInfo message from the HALO party.
    - May be skipped if doesn't exist.
    - Additionally signed by device key-chain.
1. Create party metadata item in the database.
1. Destroy the secret key for the party key.

> TODO: Difference between KeyAdmit and FeedAdmit messages.
> TODO: Separate feed keys into their own domain, disallow feed keys to sign credentials.

## Credentials state machine

> TODO
> - Initial state
> - Sets of keys tracked
> - Trusted keys
> - Invitations
> - Info messages
> - Admitted by
> - Use by message selector (i.e. message orderer).

## Authenticator

> TODO

## Proposal: Genesis feed.

Special feed that is identified and signed by the party key.

Contains credential messages that establish the party genesis, admit the first member and the first member's feed.

Genesis feed is the root of the feed DAG.
Genesis feed is the definitive starting point for the party state machine.
Only the party public key, which is also the genesis feed key, is required to discover nodes on the network, authenticate with them, start replicating, and processing the party credentials in the party state machine.


## Notes

- Credential: issuer (authority); subject; claim.

- User's private key is not used for signing (just recovery of HALO).
- Device is a signing authority for a user (e.g., to create membership credenitals).
- Device presents HALO credentials to ECHO parties to join. (HALO DAG joined with ECHO DAG)
- Device graph as part of HALO. Revocation. 
  - Optionally: Blockchain registration to resolve forks. 
  - Optionally: Publish Github credential (claim) to chain/HALO in order to recover.
- Credentials should generally have narrow claims (separation of concerns).
- Devices joining an ECHO party are like offline invitations (i.e., the joiner presents a credential).
