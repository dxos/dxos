//
// Copyright 2021 DXOS.org
//

syntax = "proto3";

import "google/protobuf/empty.proto";
import "halo/keys.proto";
import "config.proto";

package dxos.client;

//
// SYSTEM
//

service SystemService {
  rpc GetConfig(google.protobuf.Empty) returns (Config);
  rpc Reset (google.protobuf.Empty) returns (google.protobuf.Empty);
}

//
// HALO
//

message Profile {
  required dxos.halo.keys.PubKey publicKey = 1; 
  string username = 2;
}

message SubscribeProfileResponse {
  Profile profile = 1;
}

message CreateProfileRequest {
  string username = 1;
  bytes publicKey = 2;
  bytes secretKey = 3;
}

message RecoverProfileRequest { 
  string seedPhrase = 1;
}

message Invitation {
  // TODO(dmaretskyi): Split into fields.
  string invitationCode = 1;
  string secret = 2;
  bool finished = 3;
  string error = 5;
}

message InvitationProcess {
  string id = 1;
}

message AuthenticateInvitationRequest {
  InvitationProcess process = 1;
  string secret = 2;
}

message AuthenticateInvitationResponse {
  Profile profile = 1;
}

message Contact {
  dxos.halo.keys.PubKey publicKey = 1;
  string displayName = 2;
}

message Contacts {
  repeated Contact contacts = 1;
}

service ProfileService {
  rpc SubscribeProfile (google.protobuf.Empty) returns (stream SubscribeProfileResponse);
  rpc CreateProfile(CreateProfileRequest) returns (Profile);
  rpc RecoverProfile(RecoverProfileRequest) returns (Profile);
    
  rpc CreateInvitation(google.protobuf.Empty) returns (stream Invitation);
  rpc AcceptInvitation(Invitation) returns (InvitationProcess);
  rpc AuthenticateInvitation(AuthenticateInvitationRequest) returns (stream AuthenticateInvitationResponse);
    
  rpc SubscribeContacts(google.protobuf.Empty) returns (stream Contacts);
}

//
// ECHO
//

message Party {
  required dxos.halo.keys.PubKey publicKey = 1;
  required bool isOpen = 2;
  required bool isActive = 3;
}

message SubscribePartyRequest {
  required dxos.halo.keys.PubKey partyKey = 1;
}

message SubscribePartyResponse {
  Party party = 1;
}

message SubscribePartiesResponse {
  repeated Party parties = 1;
}

message OpenPartyRequest {
  required dxos.halo.keys.PubKey partyKey = 1;
}

message ClosePartyRequest {
  required dxos.halo.keys.PubKey partyKey = 1;
}

message PartyActivationOptions {
  bool global = 1;
  bool device = 2;
}

message ActivatePartyRequest {
  required dxos.halo.keys.PubKey partyKey = 1;
  required PartyActivationOptions options = 2;
}

message DeactivatePartyRequest {
  required dxos.halo.keys.PubKey partyKey = 1;
  required PartyActivationOptions options = 2;
}

message CreateInvitationRequest {
  required dxos.halo.keys.PubKey publicKey = 1;
}

message SubscribeMembersRequest {
  required dxos.halo.keys.PubKey partyKey = 1;
}

message SubscribeMembersResponse {
  // TODO(wittjosiah): Factor out.
  message PartyMember {
    required dxos.halo.keys.PubKey publicKey = 1;
    string displayName = 2;
  }

  repeated PartyMember members = 1;
}

message AuthenticatePartyInvitationResponse {
  dxos.halo.keys.PubKey partyKey = 1;
}

service PartyService {
  rpc SubscribeParty (SubscribePartyRequest) returns (stream SubscribePartyResponse);
  rpc SubscribeParties (google.protobuf.Empty) returns (stream SubscribePartiesResponse);

  rpc CreateParty(google.protobuf.Empty) returns(Party);

  rpc OpenParty(OpenPartyRequest) returns(google.protobuf.Empty);
  rpc CloseParty(ClosePartyRequest) returns(google.protobuf.Empty);

  rpc ActivateParty(ActivatePartyRequest) returns(google.protobuf.Empty);
  rpc DeactivateParty(DeactivatePartyRequest) returns(google.protobuf.Empty);

  rpc CreateInvitation(CreateInvitationRequest) returns (stream Invitation);
  rpc AcceptInvitation(Invitation) returns (InvitationProcess);
  rpc AuthenticateInvitation(AuthenticateInvitationRequest) returns (AuthenticatePartyInvitationResponse);

  rpc SubscribeMembers (SubscribeMembersRequest) returns (stream SubscribeMembersResponse);
}

