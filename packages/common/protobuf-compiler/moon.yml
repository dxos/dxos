layer: library
language: typescript
tags:
  - ts-compile
  - pack
tasks:
  compile:
    command: pnpm exec tsc
    deps:
      - prebuild
    inputs:
      - /tsconfig.base.json
      - tsconfig.json
      - '@group(production)'
    outputs:
      - dist/
    options:
      merge: replace
      timeout: 60
  prebuild:
    command: pnpm exec vite-node ./src/main.ts --src ./test/proto/**/*.proto -s ./test/proto/substitutions.ts --baseDir ./test/proto -o ./test/proto/gen
    deps:
      - ^:build
    inputs:
      - test/proto/example/
    outputs:
      - test/proto/gen/
  test:
    command: pnpm run --silent test
    deps:
      - prebuild
      - ^:compile
    inputs:
      - '@group(sources)'
