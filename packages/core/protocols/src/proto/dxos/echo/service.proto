//
// Copyright 2021 DXOS.org
//

syntax = "proto3";

import "dxos/keys.proto";
import "google/protobuf/empty.proto";

package dxos.echo.service;

message SubscribeRequest {
  string subscription_id = 1;
}

message BatchedDocumentUpdates {
  repeated DocumentUpdate updates = 1;
}

message WriteRequest {
  string subscription_id = 1;
  repeated DocumentUpdate updates = 2;
}

message UpdateSubscriptionRequest {
  /**
   * Id of the subscription to update.
   * Subscription id is returned by `Subscribe` rpc.
   */
  string subscription_id = 1;

  /**
   * Automerge document ids to subscribe for updates.
   * Used for already existing documents.
   * To add new document use `write` rpc.
   */
  repeated string add_ids = 3;

  /**
   * Automerge document ids to unsubscribe from.
   */
  repeated string remove_ids = 4;
}

message FlushRequest {
  /**
   * Automerge specific document ids to wait to flush.
   */
  repeated string document_ids = 1;
}

message DocumentUpdate {
  /**
   * Automerge document id.
   */
  string document_id = 1;

  /**
   * Automerge document incremental update.
   * Value returned by `Automerge.saveSince()`.
   */
  bytes mutation = 2;

  /**
   * Set to true for init mutation of document.
   * default: undefined.
   */
   optional bool is_new = 3;
}

message GetDocumentHeadsRequest {
  repeated string document_ids = 1;
}

message GetDocumentHeadsResponse {
  message DocState {
    string document_id = 1;
    repeated string heads = 2;
  }

  repeated DocState states = 1;
}

message ReIndexHeadsRequest {
  repeated string document_ids = 1;
}

service DataService {
  /**
   * Subscribe to incremental updates of multiple automerge socuments. 
   * Which documents are subscribed to is defined in the `UpdateSubscription`.
   * Used to propagate changes from services to client.
   */
  rpc Subscribe(SubscribeRequest) returns (stream BatchedDocumentUpdates);

  /**
   * Change which documents are subscribed to for specific subscription.
   */
  rpc UpdateSubscription(UpdateSubscriptionRequest) returns (google.protobuf.Empty);

  /**
   * Write incremental updates to multiple automerge documents.
   * Used to propagate changes from client to services.
   */
  rpc Write(WriteRequest) returns (google.protobuf.Empty);
  rpc Flush(FlushRequest) returns (google.protobuf.Empty);
  
  rpc GetDocumentHeads(GetDocumentHeadsRequest) returns (GetDocumentHeadsResponse);
  rpc ReIndexHeads(ReIndexHeadsRequest) returns (google.protobuf.Empty);
}
