import { Project, Organization, Task, Person, Message } from '@dxos/types';
//
// Copyright 2024 DXOS.org
//

import { type Meta, type StoryObj } from '@storybook/react-vite';
import React from 'react';

import { IntentPlugin, SettingsPlugin } from '@dxos/app-framework';
import { withPluginManager } from '@dxos/app-framework/testing';
import { Filter, Ref } from '@dxos/client/echo';
import { Obj, Query, Tag, Type } from '@dxos/echo';
import { AttentionPlugin } from '@dxos/plugin-attention';
import { ClientPlugin } from '@dxos/plugin-client';
import { InboxPlugin } from '@dxos/plugin-inbox';
import { PreviewPlugin } from '@dxos/plugin-preview';
import { SpacePlugin } from '@dxos/plugin-space';
import { StorybookLayoutPlugin } from '@dxos/plugin-storybook-layout';
import { ThemePlugin } from '@dxos/plugin-theme';
import { faker } from '@dxos/random';
import { useQuery, useSpace } from '@dxos/react-client/echo';
import { withTheme } from '@dxos/react-ui/testing';
import { translations as stackTranslations } from '@dxos/react-ui-stack';
import { Stack } from '@dxos/react-ui-stack';
import { defaultTx } from '@dxos/react-ui-theme';
import { createObjectFactory } from '@dxos/schema/testing';
import { Collection } from "@dxos/schema";
import { View } from "@dxos/schema";
import { Collection } from "@dxos/schema";

import { translations } from '../translations';

import { ProjectContainer } from './ProjectContainer';
import { ProjectObjectSettings } from './ProjectSettings';

faker.seed(0);

const DefaultStory = () => {
  const space = useSpace();
  const projects = useQuery(space, Filter.type(Project.Project));
  const project = projects[0];

  if (!project) {
    return <p>Loadingâ€¦</p>;
  }

  return (
    <Stack orientation='horizontal' size='split' rail={false} classNames='pli-0'>
      <ProjectContainer role='article' project={project} />
      <ProjectObjectSettings project={project} classNames='border-is border-separator' />
    </Stack>
  );
};

const meta = {
  title: 'plugins/plugin-project/ProjectContainer',
  render: DefaultStory,
  decorators: [
    withTheme,
    withPluginManager({
      plugins: [
        ClientPlugin({
          types: [
            Tag.Tag,
            Project.Project,
            DataType.View.View,
            DataType.Collection.Collection,
            Organization.Organization,
            Task.Task,
            Person.Person,
            Message.Message,
          ],
          onClientInitialized: async ({ client }) => {
            await client.halo.createIdentity();
            await client.spaces.waitUntilReady();
            const space = client.spaces.default;
            await space.waitUntilReady();

            const tag = space.db.add(Tag.make({ label: 'important', hue: 'green' }));
            const tagDxn = Obj.getDXN(tag).toString();

            // Create a project.
            const project = DataType.Project.make({ collections: [] });

            // Create a view for Contacts.
            const personView = DataType.View.make({
              name: 'Contacts',
              query: Query.select(Filter.type(Person.Person)),
              jsonSchema: Type.toJsonSchema(Person.Person),
              presentation: project,
            });

            // Create a view for Organizations.
            const organizationView = DataType.View.make({
              name: 'Organizations',
              query: Query.select(Filter.type(Organization.Organization)).select(Filter.tag(tagDxn)),
              jsonSchema: Type.toJsonSchema(Organization.Organization),
              presentation: project,
            });

            // Create a view for Tasks.
            const taskView = DataType.View.make({
              name: 'Tasks',
              query: Query.select(Filter.type(Task.Task)).select(Filter.tag(tagDxn)),
              jsonSchema: Type.toJsonSchema(Task.Task),
              presentation: project,
            });

            // Create a view for Project-Projects.
            const projectView = DataType.View.make({
              name: 'Projects (not the UI component)',
              query: Query.select(Filter.type(Project.Project)),
              jsonSchema: Type.toJsonSchema(Project.Project),
              presentation: project,
            });

            // Create a view for Messages.
            const messageQueue = space.queues.create();
            const messageView = DataType.View.make({
              name: 'Messages',
              query: Query.select(Filter.type(Message.Message)).options({
                queues: [messageQueue.dxn.toString()],
              }),
              jsonSchema: Type.toJsonSchema(Message.Message),
              presentation: project,
            });

            // Add views to project collections
            project.collections.push(Ref.make(personView));
            project.collections.push(Ref.make(organizationView));
            project.collections.push(Ref.make(taskView));
            project.collections.push(Ref.make(projectView));
            project.collections.push(Ref.make(messageView));

            // Add views and project to space
            space.db.add(personView);
            space.db.add(organizationView);
            space.db.add(taskView);
            space.db.add(projectView);
            space.db.add(messageView);
            space.db.add(project);

            // Generate sample Organizations
            Array.from({ length: 5 }).forEach(() => {
              const org = Obj.make(
                Organization.Organization,
                {
                  name: faker.company.name(),
                  website: faker.internet.url(),
                  description: faker.lorem.paragraph(),
                  image: faker.image.url(),
                },
                {
                  tags: faker.datatype.boolean() ? [Obj.getDXN(tag).toString()] : [],
                },
              );
              space.db.add(org);
            });

            // Generate sample Tasks
            Array.from({ length: 8 }).forEach(() => {
              const task = Obj.make(
                Task.Task,
                {
                  title: faker.lorem.sentence(),
                  status: faker.helpers.arrayElement(['todo', 'in-progress', 'done']) as any,
                  priority: faker.helpers.arrayElement(['low', 'medium', 'high']) as any,
                },
                {
                  tags: faker.datatype.boolean() ? [Obj.getDXN(tag).toString()] : [],
                },
              );
              space.db.add(task);
            });

            // Generate sample Contacts
            const factory = createObjectFactory(space.db, faker as any);
            await factory([{ type: Person.Person, count: 12 }]);

            // Generate sample Projects
            Array.from({ length: 3 }).forEach(() => {
              const nestedProject = DataType.Project.make({
                name: faker.commerce.productName(),
                description: faker.lorem.sentence(),
              });
              space.db.add(nestedProject);
            });

            // Generate sample Messages
            const messages = Array.from({ length: 6 }).map(() => {
              const message = Obj.make(Message.Message, {
                created: faker.date.recent().toISOString(),
                sender: { role: 'user' },
                blocks: [
                  {
                    _tag: 'text' as const,
                    text: faker.lorem.sentences(2),
                  },
                ],
              });
              return message;
            });

            await messageQueue.append(messages);
          },
        }),
        SpacePlugin({}),
        IntentPlugin(),
        SettingsPlugin(),

        // UI
        ThemePlugin({ tx: defaultTx }),
        AttentionPlugin(),
        PreviewPlugin(),
        InboxPlugin(),
        StorybookLayoutPlugin({}),
      ],
    }),
  ],
  parameters: {
    layout: 'fullscreen',
    translations: [...translations, ...stackTranslations],
  },
} satisfies Meta<typeof ProjectContainer>;

export default meta;

type Story = StoryObj<typeof meta>;

export const Default: Story = {};
