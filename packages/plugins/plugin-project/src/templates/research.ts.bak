import { Project, Message, Person, Organization } from '@dxos/types';
//
// Copyright 2025 DXOS.org
//

import { Filter, Obj, Query, Ref, Type } from '@dxos/echo';
import { Mailbox } from '@dxos/plugin-inbox/types';
import { Markdown } from '@dxos/plugin-markdown/types';
import { type Space } from '@dxos/react-client/echo';

export const createResearchProject = async (space: Space, name?: string): Promise<Project.Project | null> => {
  const { objects: mailboxes } = await space.db.query(Filter.type(Mailbox.Mailbox)).run();
  if (!mailboxes.length) {
    return null;
  }

  const mailbox = mailboxes[0];
  const mailboxView = DataType.View.make({
    name: 'Mailbox',
    query: Query.select(Filter.type(Message.Message)).options({
      queues: [mailbox.queue.dxn.toString()],
    }),
    jsonSchema: Type.toJsonSchema(Message.Message),
    presentation: Obj.make(DataType.Collection.Collection, { objects: [] }),
  });

  const contactsQuery = Query.select(Filter.type(Person.Person));
  const contactsView = DataType.View.make({
    name: 'Contacts',
    query: contactsQuery,
    jsonSchema: Type.toJsonSchema(Person.Person),
    presentation: Obj.make(DataType.Collection.Collection, { objects: [] }),
  });

  const organizationsQuery = Query.select(Filter.type(Organization.Organization));
  const organizationsView = DataType.View.make({
    name: 'Organizations',
    query: organizationsQuery,
    jsonSchema: Type.toJsonSchema(Organization.Organization),
    presentation: Obj.make(DataType.Collection.Collection, { objects: [] }),
  });

  const notesQuery = Query.select(Filter.type(Markdown.Document));
  const notesView = DataType.View.make({
    name: 'Notes',
    query: notesQuery,
    jsonSchema: Type.toJsonSchema(Markdown.Document),
    presentation: Obj.make(DataType.Collection.Collection, { objects: [] }),
  });

  return DataType.Project.make({
    name: name ?? 'Research',
    collections: [mailboxView, contactsView, organizationsView, notesView].map((view) => Ref.make(view)),
  });
};
