name: Composer Tauri Release
on:
  workflow_dispatch:
  push:
    branches:
      - labs
      - production
      - staging
      - tauri
      - jdw/homebrew

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CN_APPLICATION: "dxos/composer"

jobs:
  draft:
    runs-on: depot-ubuntu-24.04

    steps:
      - uses: actions/checkout@v4
      - name: create draft release
        uses: crabnebula-dev/cloud-release@v0
        with:
          command: release draft ${{ env.CN_APPLICATION }} --framework tauri
          api-key: ${{ secrets.CN_API_KEY }}
          working-directory: ./packages/apps/composer-app/src-tauri/

  build:
    needs: draft

    strategy:
      fail-fast: false
      matrix:
        os:
          - depot-macos-latest
          # - depot-ubuntu-24.04-4
          # - depot-windows-2022-4

    runs-on: ${{ matrix.os }}

    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4

      - uses: 'moonrepo/setup-toolchain@v0'

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true

      - name: Cache Homebrew
        if: matrix.os == 'depot-macos-latest'
        uses: actions/cache@v4
        id: homebrew-cache
        with:
          path: |
            /opt/homebrew/Cellar
            /opt/homebrew/Caskroom
            /opt/homebrew/Homebrew
            ~/.cache/Homebrew
          key: ${{ runner.os }}-homebrewA-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-homebrewA-

      - name: Install macOS dependencies
        if: matrix.os == 'depot-macos-latest'
        run: |
          # Install Homebrew if not available
          if ! command -v brew &> /dev/null; then
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> $HOME/.zprofile
            eval "$(/opt/homebrew/bin/brew shellenv)"
          fi
          
          # If cache was restored, reinstall packages to ensure proper linking
          if [ "${{ steps.homebrew-cache.outputs.cache-hit }}" == "true" ]; then
            echo "Cache hit - reinstalling packages to ensure proper linking"
            brew reinstall cairo giflib git-lfs jpeg libpng librsvg pango pkg-config python-setuptools git unzip gzip xz
          else
            echo "Cache miss - installing packages fresh"
            brew install cairo giflib git-lfs jpeg libpng librsvg pango pkg-config python-setuptools git unzip gzip xz
          fi

      - run: moon run async:build
