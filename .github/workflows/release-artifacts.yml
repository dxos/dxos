# https://github.com/marketplace/actions/github-releases
 
on: push
name: Add artifacts to releases
jobs:
  release:
    name: Devtools
    runs-on: [self-hosted, dind-actions-runner]
    timeout-minutes: 25
    env:
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          clean: false
      - name: Check, install and build
        run: |
          \. "$NVM_DIR/nvm.sh" && nvm use

          # Install dependencies
          echo "::group::Install"
          node common/scripts/install-run-rush.js install
          echo "::endgroup::"

          # Build with tests
          node common/scripts/github-actions-folding.js node common/scripts/install-run-rush.js build:test --verbose
      - name: Release
        uses: fnkr/github-action-ghr@v1
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GHR_COMPRESS: xz
          GHR_PATH: packages/devtools/devtools-extension/dist
          GITHUB_TOKEN: ${{ secrets.CREATE_PR_TOKEN }}
