#
# Copyright 2021 DXOS.org
#

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * 1,3,5'

name: Standardize configs

jobs:
  update:
    name: Update package.json and tsconfig.json files
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v2
      - name: Setup
        run: |
          npm install -g yarn @microsoft/rush
          yarn global add @dxos/x@1.4.38
      - name: Update tsconfig.json references
        run: |
          npx @monorepo-utils/workspaces-to-typescript-project-references@2.7.4
      - name: Sort package.json and tsconfig.json files
        run: |
          export PATH="$PATH:$(yarn global bin)"
          # For some reason if this isn't called first it doesn't recognize the rush project.
          # This causes it only to sort the root files and not each package as well.
          rush list --json
          dxtools deps sort
      - name: Create pull request
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.CREATE_PR_TOKEN }}
          commit-message: |
            chore: Sort package.json and update references in tsconfig.json files
          committer: DXOS Bot <ci@dxos.org>
          author: DXOS Bot <ci@dxos.org>
          branch: standardize-configs
          title: |
            chore: Sort package.json and update references in tsconfig.json files
